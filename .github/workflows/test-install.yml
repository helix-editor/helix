name: Test Install Scripts

on:
  workflow_dispatch:

jobs:
  test-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Test install.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Testing install.sh from silicon-editor.pages.dev ==="
          # Download and run install script, but skip the health check
          # (release binary may use CPU features not on CI runners)
          curl -fsSL https://silicon-editor.pages.dev/install.sh > /tmp/install.sh
          # Patch out the health check to avoid SIGILL on CI
          sed -i 's/si --health/echo "skipping health check on CI"/' /tmp/install.sh
          sh /tmp/install.sh
          echo ""
          echo "=== Verifying binary ==="
          ls -la ~/.local/bin/si
          file ~/.local/bin/si
          echo "=== Verifying runtime ==="
          ls ~/.local/share/silicon/runtime/
          echo "=== LINUX TEST PASSED ==="

  test-macos:
    runs-on: macos-latest
    steps:
      - name: Test install.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Testing install.sh on macOS ==="
          curl -fsSL https://silicon-editor.pages.dev/install.sh | sh
          echo ""
          echo "=== Verifying ==="
          ls -la ~/.local/bin/si
          ~/.local/bin/si --version
          ls ~/Library/Application\ Support/silicon/runtime/
          echo "=== MACOS TEST PASSED ==="

  test-windows:
    runs-on: windows-latest
    steps:
      - name: Test install.ps1
        shell: pwsh
        run: |
          Write-Host "=== Testing install.ps1 from silicon-editor.pages.dev ==="
          irm silicon-editor.pages.dev/install.ps1 | iex
          Write-Host ""
          Write-Host "=== Verifying ==="
          $siPath = Join-Path $env:LOCALAPPDATA 'Programs\silicon\si.exe'
          if (Test-Path $siPath) {
              & $siPath --version
              Get-ChildItem (Join-Path $env:APPDATA 'silicon\runtime')
              Write-Host "=== WINDOWS TEST PASSED ==="
          } else {
              Write-Host "FAILED: si.exe not found at $siPath"
              exit 1
          }
